<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Personal MAL Ratings</title>
    <!-- Version 1.1.0 with Test Buttons -->
    <meta name="cache-bust" content="20250117-v1.2.0">
</head>
<body>
    <div id="PersonalMALRatingsConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <form id="PersonalMALRatingsConfigForm">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Personal MAL Ratings Configuration</h2>
                    </div>
                    
                    <div class="verticalSection">
                        <div class="sectionTitleContainer">
                            <h3 class="sectionTitle">MyAnimeList API Settings</h3>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtMALUsername">MAL Username</label>
                            <input id="txtMALUsername" name="txtMALUsername" type="text" is="emby-input" class="emby-input" />
                            <div class="fieldDescription">Your MyAnimeList username (for reference only)</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtMALClientId">MAL Client ID</label>
                            <input id="txtMALClientId" name="txtMALClientId" type="text" is="emby-input" class="emby-input" />
                            <div class="fieldDescription">Your MAL API Client ID (register at https://myanimelist.net/apiconfig/create)</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtMALAccessToken">MAL Access Token</label>
                            <input id="txtMALAccessToken" name="txtMALAccessToken" type="password" is="emby-input" class="emby-input" />
                            <div class="fieldDescription">Your MAL API Access Token (obtain through OAuth2 flow)</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtMALRefreshToken">MAL Refresh Token</label>
                            <input id="txtMALRefreshToken" name="txtMALRefreshToken" type="password" is="emby-input" class="emby-input" />
                            <div class="fieldDescription">Your MAL API Refresh Token (for automatic token renewal)</div>
                        </div>
                    </div>
                    
                    <div class="verticalSection">
                        <div class="sectionTitleContainer">
                            <h3 class="sectionTitle">Shoko Server Integration</h3>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="chkEnableShokoIntegration" name="chkEnableShokoIntegration" type="checkbox" is="emby-checkbox" />
                                <span>Enable Shoko Integration</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Use Shoko Server for more accurate anime identification via AniDB</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtShokoServerUrl">Shoko Server URL</label>
                            <input id="txtShokoServerUrl" name="txtShokoServerUrl" type="text" is="emby-input" class="emby-input" placeholder="http://localhost:8111" />
                            <div class="fieldDescription">URL to your Shoko Server instance (e.g., http://localhost:8111)</div>
                        </div>
                        
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="txtShokoApiKey">Shoko API Key</label>
                            <input id="txtShokoApiKey" name="txtShokoApiKey" type="password" is="emby-input" class="emby-input" />
                            <div class="fieldDescription">API key for Shoko Server (optional - leave empty if no authentication required)</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="chkUseShokoAsPrimary" name="chkUseShokoAsPrimary" type="checkbox" is="emby-checkbox" />
                                <span>Use Shoko as Primary Source</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Try Shoko identification first before falling back to string matching</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="chkFallbackToStringMatching" name="chkFallbackToStringMatching" type="checkbox" is="emby-checkbox" />
                                <span>Fallback to String Matching</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Use traditional string matching if Shoko identification fails</div>
                        </div>
                    </div>
                    
                    <div class="verticalSection">
                        <div class="sectionTitleContainer">
                            <h3 class="sectionTitle">Plugin Settings</h3>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="chkEnabledForAnime" name="chkEnabledForAnime" type="checkbox" is="emby-checkbox" />
                                <span>Enable for Anime</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Enable rating override for anime series</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="chkOverwriteExistingRatings" name="chkOverwriteExistingRatings" type="checkbox" is="emby-checkbox" />
                                <span>Overwrite Existing Ratings</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">Replace existing community ratings with your personal MAL ratings</div>
                        </div>
                        
                        <div class="selectContainer">
                            <label class="selectLabel" for="selectRefreshInterval">Refresh Interval</label>
                            <select id="selectRefreshInterval" name="selectRefreshInterval" is="emby-select" class="emby-select-withcolor emby-select">
                                <option value="1">1 hour</option>
                                <option value="6">6 hours</option>
                                <option value="12">12 hours</option>
                                <option value="24">24 hours</option>
                                <option value="48">48 hours</option>
                                <option value="168">1 week</option>
                            </select>
                            <div class="fieldDescription">How often to refresh your MAL anime list</div>
                        </div>
                    </div>
                    
                    <div class="verticalSection">
                        <div class="sectionTitleContainer">
                            <h3 class="sectionTitle">Unrated Shows Handling</h3>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="chkSetUnratedRatingToZero" name="chkSetUnratedRatingToZero" type="checkbox" is="emby-checkbox" />
                                <span>Set Unrated Shows Community Rating to 0</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">When a show is found in your MAL list but has no personal rating, set its community rating to 0</div>
                        </div>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="chkSetUnmatchedRatingToZero" name="chkSetUnmatchedRatingToZero" type="checkbox" is="emby-checkbox" />
                                <span>Set Unmatched Shows Community Rating to 0</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">When a show is NOT found in your MAL list at all, set its community rating to 0</div>
                        </div>
                    </div>
                    
                    <div class="verticalSection">
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                        
                        <button id="btnTestConnection" type="button" class="raised button-submit block emby-button" style="margin-top: 1em;">
                            <span>Test MAL Connection & Generate Logs</span>
                        </button>
                        
                        <button id="btnRefreshCache" type="button" class="raised button-submit block emby-button" style="margin-top: 0.5em;">
                            <span>Force Cache Refresh</span>
                        </button>
                        
                        <button id="btnForceMetadata" type="button" class="raised button-submit block emby-button" style="margin-top: 0.5em;">
                            <span>Force Metadata Updates on Anime</span>
                        </button>
                        
                        <button id="btnTestShoko" type="button" class="raised button-submit block emby-button" style="margin-top: 0.5em;">
                            <span>Test Shoko Connection</span>
                        </button>
                        
                        <div id="testResults" style="margin-top: 1em; padding: 1em; border-radius: 4px; display: none;">
                            <div id="testMessage"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <script type="text/javascript">
            (function () {
                var pluginId = "85E35A5A-8C2D-4F3A-9B1E-7F8D6C4E2A91";

                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    document.querySelector('#txtMALUsername').value = config.MALUsername || '';
                    document.querySelector('#txtMALClientId').value = config.MALClientId || '';
                    document.querySelector('#txtMALAccessToken').value = config.MALAccessToken || '';
                    document.querySelector('#txtMALRefreshToken').value = config.MALRefreshToken || '';
                    document.querySelector('#chkEnabledForAnime').checked = config.EnabledForAnime !== false;
                    document.querySelector('#chkOverwriteExistingRatings').checked = config.OverwriteExistingRatings !== false;
                    document.querySelector('#selectRefreshInterval').value = config.RefreshIntervalHours || 24;
                    
                    // Shoko settings
                    document.querySelector('#chkEnableShokoIntegration').checked = config.EnableShokoIntegration === true;
                    document.querySelector('#txtShokoServerUrl').value = config.ShokoServerUrl || 'http://localhost:8111';
                    document.querySelector('#txtShokoApiKey').value = config.ShokoApiKey || '';
                    document.querySelector('#chkUseShokoAsPrimary').checked = config.UseShokoAsprimary !== false;
                    document.querySelector('#chkFallbackToStringMatching').checked = config.FallbackToStringMatching !== false;
                    
                    // Unrated shows settings
                    document.querySelector('#chkSetUnratedRatingToZero').checked = config.SetUnratedRatingToZero === true;
                    document.querySelector('#chkSetUnmatchedRatingToZero').checked = config.SetUnmatchedRatingToZero === true;
                });

                document.querySelector('#PersonalMALRatingsConfigForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    
                    var config = {
                        MALUsername: document.querySelector('#txtMALUsername').value,
                        MALClientId: document.querySelector('#txtMALClientId').value,
                        MALAccessToken: document.querySelector('#txtMALAccessToken').value,
                        MALRefreshToken: document.querySelector('#txtMALRefreshToken').value,
                        EnabledForAnime: document.querySelector('#chkEnabledForAnime').checked,
                        OverwriteExistingRatings: document.querySelector('#chkOverwriteExistingRatings').checked,
                        RefreshIntervalHours: parseInt(document.querySelector('#selectRefreshInterval').value),
                        
                        // Shoko settings
                        EnableShokoIntegration: document.querySelector('#chkEnableShokoIntegration').checked,
                        ShokoServerUrl: document.querySelector('#txtShokoServerUrl').value,
                        ShokoApiKey: document.querySelector('#txtShokoApiKey').value,
                        UseShokoAsprimary: document.querySelector('#chkUseShokoAsPrimary').checked,
                        FallbackToStringMatching: document.querySelector('#chkFallbackToStringMatching').checked,
                        
                        // Unrated shows settings
                        SetUnratedRatingToZero: document.querySelector('#chkSetUnratedRatingToZero').checked,
                        SetUnmatchedRatingToZero: document.querySelector('#chkSetUnmatchedRatingToZero').checked
                    };

                    ApiClient.updatePluginConfiguration(pluginId, config).then(function () {
                        Dashboard.processPluginConfigurationUpdateResult();
                    });
                });

                function showTestResult(success, message) {
                    var resultsDiv = document.querySelector('#testResults');
                    var messageDiv = document.querySelector('#testMessage');
                    
                    resultsDiv.style.display = 'block';
                    resultsDiv.style.backgroundColor = success ? '#d4edda' : '#f8d7da';
                    resultsDiv.style.borderColor = success ? '#c3e6cb' : '#f5c6cb';
                    resultsDiv.style.color = success ? '#155724' : '#721c24';
                    
                    messageDiv.textContent = message;
                }

                document.querySelector('#btnTestConnection').addEventListener('click', function () {
                    var accessToken = document.querySelector('#txtMALAccessToken').value;
                    
                    if (!accessToken) {
                        showTestResult(false, 'Please enter an access token first.');
                        return;
                    }
                    
                    this.disabled = true;
                    this.innerHTML = '<span>Testing & Generating Logs...</span>';
                    
                    fetch(ApiClient.getUrl('Plugins/PersonalMALRatings/test'), {
                        method: 'POST',
                        headers: {
                            'Authorization': 'MediaBrowser Token="' + ApiClient.accessToken() + '"',
                            'Content-Type': 'application/json'
                        }
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        document.querySelector('#btnTestConnection').disabled = false;
                        document.querySelector('#btnTestConnection').innerHTML = '<span>Test MAL Connection & Generate Logs</span>';
                        
                        showTestResult(data.Success, data.Message);
                    }).catch(function(error) {
                        document.querySelector('#btnTestConnection').disabled = false;
                        document.querySelector('#btnTestConnection').innerHTML = '<span>Test MAL Connection & Generate Logs</span>';
                        showTestResult(false, 'Test failed: ' + error.message);
                    });
                });

                document.querySelector('#btnRefreshCache').addEventListener('click', function () {
                    this.disabled = true;
                    this.innerHTML = '<span>Refreshing...</span>';
                    
                    fetch(ApiClient.getUrl('Plugins/PersonalMALRatings/refresh'), {
                        method: 'POST',
                        headers: {
                            'Authorization': 'MediaBrowser Token="' + ApiClient.accessToken() + '"',
                            'Content-Type': 'application/json'
                        }
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        document.querySelector('#btnRefreshCache').disabled = false;
                        document.querySelector('#btnRefreshCache').innerHTML = '<span>Force Cache Refresh</span>';
                        
                        showTestResult(data.Success, data.Message);
                    }).catch(function(error) {
                        document.querySelector('#btnRefreshCache').disabled = false;
                        document.querySelector('#btnRefreshCache').innerHTML = '<span>Force Cache Refresh</span>';
                        showTestResult(false, 'Cache refresh failed: ' + error.message);
                    });
                });

                document.querySelector('#btnForceMetadata').addEventListener('click', function () {
                    this.disabled = true;
                    this.innerHTML = '<span>Processing Anime...</span>';
                    
                    fetch(ApiClient.getUrl('Plugins/PersonalMALRatings/force-metadata'), {
                        method: 'POST',
                        headers: {
                            'Authorization': 'MediaBrowser Token="' + ApiClient.accessToken() + '"',
                            'Content-Type': 'application/json'
                        }
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        document.querySelector('#btnForceMetadata').disabled = false;
                        document.querySelector('#btnForceMetadata').innerHTML = '<span>Force Metadata Updates on Anime</span>';
                        
                        showTestResult(data.Success, data.Message);
                    }).catch(function(error) {
                        document.querySelector('#btnForceMetadata').disabled = false;
                        document.querySelector('#btnForceMetadata').innerHTML = '<span>Force Metadata Updates on Anime</span>';
                        showTestResult(false, 'Metadata updates failed: ' + error.message);
                    });
                });

                document.querySelector('#btnTestShoko').addEventListener('click', function () {
                    var shokoUrl = document.querySelector('#txtShokoServerUrl').value;
                    var shokoApiKey = document.querySelector('#txtShokoApiKey').value;
                    
                    if (!shokoUrl) {
                        showTestResult(false, 'Please enter a Shoko server URL first.');
                        return;
                    }
                    
                    this.disabled = true;
                    this.innerHTML = '<span>Testing Shoko Connection...</span>';
                    
                    fetch(ApiClient.getUrl('Plugins/PersonalMALRatings/test-shoko'), {
                        method: 'POST',
                        headers: {
                            'Authorization': 'MediaBrowser Token="' + ApiClient.accessToken() + '"',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ShokoServerUrl: shokoUrl,
                            ShokoApiKey: shokoApiKey
                        })
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        document.querySelector('#btnTestShoko').disabled = false;
                        document.querySelector('#btnTestShoko').innerHTML = '<span>Test Shoko Connection</span>';
                        
                        showTestResult(data.Success, data.Message);
                    }).catch(function(error) {
                        document.querySelector('#btnTestShoko').disabled = false;
                        document.querySelector('#btnTestShoko').innerHTML = '<span>Test Shoko Connection</span>';
                        showTestResult(false, 'Shoko test failed: ' + error.message);
                    });
                });
            })();
        </script>
    </div>
</body>
</html>